<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูููุฐุฌ ุงุฎุชุจุงุฑ ูุฏุฑุณุฉ ูููุญุฉ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; } .hidden { display: none; }
        .loader-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.7); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .loader { border: 5px solid #f3f3f3; border-radius: 50%; border-top: 5px solid #3498db; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="password-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-11/12 md:w-1/3 mx-auto">
            <h3 id="password-modal-title" class="text-xl font-bold mb-4">ูุทููุจ ูููุฉ ุงููุฑูุฑ</h3>
            <p class="mb-4">ุงูุฑุฌุงุก ุฅุฏุฎุงู ูููุฉ ุงููุฑูุฑ ูููุชุงุจุนุฉ.</p>
            <input type="password" id="password-input" class="w-full p-2 border border-gray-300 rounded-md mb-2 text-left" dir="ltr">
            <p id="password-error" class="text-red-500 text-sm mb-4 hidden">ูููุฉ ุงูุณุฑ ุฎุงุทุฆุฉ. ุงูุฑุฌุงุก ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.</p>
            <div class="flex justify-end gap-4">
                <button onclick="closePasswordModal()" class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded">ุฅูุบุงุก</button>
                <button onclick="checkPassword()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">ุฏุฎูู</button>
            </div>
        </div>
    </div>

    <div id="main-container" class="container mx-auto p-4 md:p-8">
        <div id="home-screen" class="text-center">
            <img src="https://www.moe.gov.ae/ar/assets/images/logo.png" alt="ุดุนุงุฑ ูุฒุงุฑุฉ ุงูุชุฑุจูุฉ ูุงูุชุนููู" class="mx-auto mb-6 h-24 w-auto object-contain">
            <h1 class="text-2xl md:text-4xl font-bold text-blue-800 mb-2">ูุฏุฑุณุฉ ูููุญุฉ ุงูุญููุฉ ุงูุฃููู ูุงูุซุงููุฉ ูุงูุซุงูุซุฉ ุจูุงุช</h1>
            <h2 class="text-xl md:text-2xl font-semibold text-gray-700 mb-6">Maleeha School Cycle 1,2,3 for Girls</h2>
            <div class="max-w-2xl mx-auto text-center">
                <p class="text-lg text-gray-600 mb-2">ูุฑุญุจูุง ุจูู ูู ูููุฐุฌ ุงูุงุฎุชุจุงุฑ ุงูุฅููุชุฑููู.</p>
                <p class="text-lg text-gray-600 mb-10">ูุฑุฌู ูููู ูุฑุงุกุฉ ุงูุฃุณุฆูุฉ ุจุนูุงูุฉ ูุงูุฅุฌุงุจุฉ ุจุฏูุฉุ ูุน ุชูููุงุชูุง ููู ุจุงูุชูููู ูุงููุฌุงุญ ๐</p>
            </div>
            <div class="flex flex-col md:flex-row justify-center gap-4">
                <button onclick="showView('teacher-login')" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300">ุฎุงุต ูููุนููุฉ</button>
                <button onclick="showView('student-login')" class="bg-green-500 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300">ุฎุงุต ููุทูุงุจ</button>
            </div>
        </div>

        <div id="teacher-login" class="hidden text-center">
            <h2 class="text-2xl font-bold text-blue-600 mb-4">ุฏุฎูู ุงููุนููุฉ</h2>
            <p class="text-gray-600 mb-6">ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุงุณูู ูู ุงููุงุฆูุฉ.</p>
            <select id="teacher-select" class="w-full md:w-1/2 mx-auto p-3 border border-gray-300 rounded-md mb-4">
                <option value="">-- ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุงููุนููุฉ --</option>
            </select>
            <button onclick="promptTeacherPassword()" class="bg-purple-600 hover:bg-purple-800 text-white font-bold py-2 px-6 rounded-lg">ุงูุชุงูู</button>
            <button onclick="showView('home-screen')" class="text-sm text-gray-500 hover:underline mt-4 block mx-auto">&larr; ุงูุนูุฏุฉ ููุฑุฆูุณูุฉ</button>
        </div>

        <div id="teacher-view" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 id="teacher-view-title" class="text-2xl font-bold text-blue-600">ููุญุฉ ุชุญูู ุงููุนููุฉ</h2>
                <button onclick="showView('home-screen')" class="text-sm text-blue-500 hover:underline">&larr; ุงูุนูุฏุฉ ููุฑุฆูุณูุฉ</button>
            </div>
            <form id="quiz-form" class="bg-white p-6 rounded-lg shadow-md space-y-8"></form>
            <div id="teacher-feedback" class="text-center mt-4 font-bold"></div>
        </div>
        
        <div id="student-login" class="hidden text-center">
             <h2 class="text-2xl font-bold text-green-600 mb-4">ุฏุฎูู ุงูุทุงูุจ</h2>
             <p class="text-gray-600 mb-6">ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุจูุงูุงุช ุงูุงุฎุชุจุงุฑ ููุฏุฎูู.</p>
             <div class="max-w-md mx-auto space-y-4">
                <select id="subject-select" class="w-full p-3 border border-gray-300 rounded-md"></select>
                <select id="class-select" class="w-full p-3 border border-gray-300 rounded-md"></select>
                <input type="password" id="exam-password-input" placeholder="ูููุฉ ุณุฑ ุงูุงุฎุชุจุงุฑ" class="w-full p-3 border border-gray-300 rounded-md">
             </div>
             <button onclick="findQuiz()" class="bg-green-600 hover:bg-green-800 text-white font-bold py-2 px-6 rounded-lg mt-6">ุจุญุซ ุนู ุงูุงุฎุชุจุงุฑ</button>
             <button onclick="showView('home-screen')" class="text-sm text-gray-500 hover:underline mt-4 block mx-auto">&larr; ุงูุนูุฏุฉ ููุฑุฆูุณูุฉ</button>
             <p id="student-login-error" class="text-red-500 mt-4 font-bold"></p>
        </div>

        <div id="student-view" class="hidden">
            <div class="flex justify-between items-center mb-6">
                 <h2 id="student-view-title" class="text-2xl font-bold text-green-600">ุตูุญุฉ ุงูุทุงูุจ - ุงูุงุฎุชุจุงุฑ</h2>
                 <button onclick="showView('home-screen')" class="text-sm text-blue-500 hover:underline">&larr; ุงูุนูุฏุฉ ููุฑุฆูุณูุฉ</button>
            </div>
            <div id="student-name-input" class="bg-white p-6 rounded-lg shadow-md text-center">
                <h3 class="text-xl font-semibold mb-4">ุฃุฏุฎู ุงุณูู ูุจุฏุก ุงูุงุฎุชุจุงุฑ</h3>
                <input type="text" id="student-name" placeholder="ุงุณูู ุงููุงูู" class="w-full md:w-1/2 mx-auto p-2 border border-gray-300 rounded-md mb-4" required>
                <button onclick="startQuiz()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">ุจุฏุก ุงูุงุฎุชุจุงุฑ</button>
            </div>
            <div id="quiz-container" class="hidden bg-white p-6 rounded-lg shadow-md space-y-6"></div>
            <div id="student-result" class="hidden text-center mt-6 bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-2xl font-bold text-green-600">ูุชูุฌุชู ุงูููุงุฆูุฉ</h3>
                <p id="score-display" class="text-4xl font-bold my-4"></p>
                <button onclick="showView('home-screen')" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">ุงูุนูุฏุฉ ููุฑุฆูุณูุฉ</button>
            </div>
            <div id="student-feedback" class="text-center mt-4 font-bold"></div>
        </div>
        <div id="loader" class="loader-container hidden"><div class="loader"></div><p class="mt-2 text-gray-600">ุฌุงุฑู ุงูุชุญููู...</p></div>
    </div>
    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwXq4yQolNrFZCMmqaok9dmrTm04vVPJ7azuRNEcgx_dEiR5hm2_zgAkmQNZG7zSMMMKA/exec';
        const teachersData = [
            { name: "Alza Babu Manamil Thomas Babu", password: "999", sheetId: "1zZe5-ne-I3XKHpV87uB-l_Gfk-0dmiM1veMjL8yAsi0" },
            { name: "amneh awad", password: "991", sheetId: "11a7YK2AIzZZ9f0iJfd9MwuNOhgKzJby5w41L6uzBS4k" },
            { name: "Aysha Jumaa", password: "983", sheetId: "18rjlmWKyuR56of_0YnJGjgcpgJuCrKX-cUpuMIwSN00" },
            { name: "Azza Abdullah", password: "975", sheetId: "1yNnqe-AvuqYUNk926_9SMo6Sx8ExUjwQXBSsTmhFmvI" },
            { name: "batoul khalil mahmoud", password: "967", sheetId: "11dFkIjo9X92rseqF3Gapm7CM2_vsI42MQ7YohWyJnog" },
            { name: "Debiti Akara Vitel", password: "959", sheetId: "1O6JMLZexc5vFrc_a4jznFa4d53HLwh66oRiL-8dpdHE" },
            { name: "fadia gasem", password: "951", sheetId: "1h_gFZD6-jV_Y4pi-UVaqqcP1kgG0ZjUaQKgI0WRPCXo" },
            { name: "ghada obaed", password: "943", sheetId: "13bVojODlqgHXR3fQHxcK5hqO_UIgfFFTcdt2X5cSO0A" },
            { name: "halima ahmad", password: "935", sheetId: "1mV5tbW7Mpk-0B7AU7ZfC0j43Cgf6XCC_h44f5GOaPLg" },
            { name: "iman hamad", password: "927", sheetId: "1k6qwtdJ7S4-bgkdcyyF8Y8oBoxbDQCeyWCaLLL061rc" },
            { name: "Iman mohammad ibraheem", password: "919", sheetId: "1b2nTWfPG0zykhoheSlg8ThCSbMwvsdN3wQIoYsmxtYQ" },
            { name: "kawthar sultan", password: "911", sheetId: "1uTviDScAvTbtBArnMV-8j-roNuaXLNyHSiWq3i60mYs" },
            { name: "khasiba saeed", password: "903", sheetId: "1iDmXs5sPxoFl8Kwe3CX0ukhAhRkWRhvSH28lndAx75s" },
            { name: "mariam mohammad jaber", password: "895", sheetId: "1PLARCqBZPek4f3-3dAgY1mFgkyVNR2XJ99hcFGZtFkg" },
            { name: "mariam naser naeaa", password: "887", sheetId: "1zTI5NVGcyggcYmx9QOKqrVEs2dZaylSbgPFrWmTrrSU" },
            { name: "moza ali kaderi", password: "879", sheetId: "1y0-fFQy0nXXcYpTpMEU0s7LerYJctI0enA5gELN2zNQ" },
            { name: "nadia azzam", password: "871", sheetId: "1smS-1PBM4kNT1bAsecjWHSsQmfCUaQ_CqCIjhMOD0WA" },
            { name: "naema mohammed", password: "863", sheetId: "1jCqpnt_y5AzBm37FQinQFqOpKaHm_hr2cWGTNu2dB94" },
            { name: "Nahid Ahmad", password: "855", sheetId: "1J5tJqvJSu1xPD1BKbhkb--kuOluPns13QQkLvCnPGTc" },
            { name: "Nair Anouga", password: "847", sheetId: "1rEtCYNzAWom3U4sIsIFF50YNHsQdM5Y--8zlj7-Pi7w" },
            { name: "najwa jamal", password: "839", sheetId: "1TRu7uLSULOX_5ppMqzwCQCs8gHw-eEUJAX2VHeHYFZU" },
            { name: "noura jasem", password: "831", sheetId: "1FxvfcpYUt9lQ6W2LcS7v_KXciRzpepuEGG9kLEqvG-k" },
            { name: "Rasha Mohammad mansor", password: "823", sheetId: "1yBV7qQAagL15tCsg2lgZtkYkXnE9K70Y_1UUJOTapWw" },
            { name: "reham ali hussain", password: "815", sheetId: "1PPzylrVIfVc3VI8UbZZo8yjFT88eJLPQ86JT_88-_V0" },
            { name: "sabiha saif", password: "807", sheetId: "1ASav86PXjYXe1sU4bqglo3m_vZwqy7caF6C3T-1mMpU" },
            { name: "salameh saeed", password: "799", sheetId: "1Wa9d7igE4ak8n6KxWK3sbvaouTKZLcTkiewcTIejPIQ" },
            { name: "suad ahmad hussain", password: "791", sheetId: "1MAC6kWVKqXbZTfZ2k_EyeeYokXZpNNxl8lEUGqk-46M" },
            { name: "suhaila sultan", password: "783", sheetId: "1U4npVz6sh9IOk4eufzEFHury5Df-v0zThoB2pYR3xkA" },
            { name: "Tingo Babu", password: "775", sheetId: "1Ju5rAtmh2Fhl2U4oadliJXeBpxTIXsehSvq6SAApa4I" }
        ];

        const subjects = ["ุงููุบุฉ ุงูุนุฑุจูุฉ", "ุงูุชุฑุจูุฉ ุงูุฅุณูุงููุฉ", "ุงูุบุฉ ุงูุฅูุฌููุฒูุฉ", "ุงูุฏุฑุงุณุงุช ุงูุงุฌุชูุงุนูุฉ", "ุงูุฑูุงุถูุงุช", "ุงูุนููู", "ุงูููุฒูุงุก", "ุงูููููุงุก", "ุงูุงุญูุงุก", "ุงูุชุฑุจูุฉ ุงูุจุฏููุฉ ูุงูุตุญูุฉ", "ุงูุญูุณุจุฉ ูุงูุชุตููู", "ุงููููู (ูููุฉ ูููุณููู)", "ุงุฏุงุฑุฉ ุงุนูุงู"];
        const classNames = ["ุงูุตู ุงูุฃูู", "ุงูุตู ุงูุซุงูู", "ุงูุตู ุงูุซุงูุซ", "ุงูุตู ุงูุฑุงุจุน", "ุงูุตู ุงูุฎุงูุณ", "ุงูุตู ุงูุณุงุฏุณ", "ุงูุตู ุงูุณุงุจุน", "ุงูุตู ุงูุซุงูู", "ุงูุตู ุงูุชุงุณุน", "ุงูุตู ุงูุนุงุดุฑ", "ุงูุตู ุงูุญุงุฏู ุนุดุฑ", "ุงูุตู ุงูุซุงูู ุนุดุฑ"];

        const views = ['home-screen', 'teacher-login', 'teacher-view', 'student-login', 'student-view'];
        const teacherForm = document.getElementById('quiz-form');
        const teacherFeedback = document.getElementById('teacher-feedback');
        const studentFeedback = document.getElementById('student-feedback');
        const loader = document.getElementById('loader');
        const passwordModal = document.getElementById('password-modal');
        const passwordInput = document.getElementById('password-input');
        const passwordError = document.getElementById('password-error');
        
        let questionsData = [];
        let currentTeacher = null;
        let currentSheetId = '';

        function populateDropdowns() {
            const teacherSelect = document.getElementById('teacher-select');
            teachersData.forEach((teacher, index) => {
                teacherSelect.innerHTML += `<option value="${index}">${teacher.name}</option>`;
            });
            const subjectSelect = document.getElementById('subject-select');
            subjectSelect.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงููุงุฏุฉ --</option>';
            subjects.forEach(s => { subjectSelect.innerHTML += `<option value="${s}">${s}</option>`; });

            const classSelect = document.getElementById('class-select');
            classSelect.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงูุตู --</option>';
            classNames.forEach(c => { classSelect.innerHTML += `<option value="${c}">${c}</option>`; });
        }
        window.onload = populateDropdowns;

        function generateTeacherForm() {
            let subjectOptions = subjects.map(s => `<option value="${s}">${s}</option>`).join('');
            let classOptions = classNames.map(c => `<option value="${c}">${c}</option>`).join('');
            let formHtml = `
                <div class="grid md:grid-cols-3 gap-4 mb-8 border-b pb-6">
                    <select id="subject" class="w-full p-3 border border-gray-300 rounded-md" required><option value="">-- ุงุฎุชุฑ ุงููุงุฏุฉ --</option>${subjectOptions}</select>
                    <select id="className" class="w-full p-3 border border-gray-300 rounded-md" required><option value="">-- ุงุฎุชุฑ ุงูุตู --</option>${classOptions}</select>
                    <input type="text" id="examPassword" placeholder="ูููุฉ ุณุฑ ููุงุฎุชุจุงุฑ" class="w-full p-3 border border-gray-300 rounded-md" required>
                </div>
            `;
            for (let i = 1; i <= 3; i++) {
                formHtml += `<div class="question-block ${i < 3 ? 'border-b pb-6' : ''}"><h3 class="text-xl font-semibold mb-4">ุงูุณุคุงู ${i}</h3><div class="space-y-4"><input type="text" id="q${i}" placeholder="ุงูุชุจ ูุต ุงูุณุคุงู ${i} ููุง" class="w-full p-2 border border-gray-300 rounded-md" required><input type="text" id="q${i}_opt1" placeholder="ุงูุฎูุงุฑ ุงูุฃูู" class="w-full p-2 border border-gray-300 rounded-md" required><input type="text" id="q${i}_opt2" placeholder="ุงูุฎูุงุฑ ุงูุซุงูู" class="w-full p-2 border border-gray-300 rounded-md" required><input type="text" id="q${i}_opt3" placeholder="ุงูุฎูุงุฑ ุงูุซุงูุซ" class="w-full p-2 border border-gray-300 rounded-md" required><div class="flex items-center gap-4"><select id="q${i}_correct" class="p-2 border border-gray-300 rounded-md"><option value="1">ุงูุฎูุงุฑ ุงูุฃูู ูู ุงูุตุญูุญ</option><option value="2">ุงูุฎูุงุฑ ุงูุซุงูู ูู ุงูุตุญูุญ</option><option value="3">ุงูุฎูุงุฑ ุงูุซุงูุซ ูู ุงูุตุญูุญ</option></select><input type="number" id="q${i}_score" placeholder="ุนูุงูุฉ ุงูุณุคุงู" class="w-32 p-2 border border-gray-300 rounded-md" required></div></div></div>`;
            }
            formHtml += `<div class="text-center pt-4"><button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition duration-300">ุญูุธ ุงูุงุฎุชุจุงุฑ</button></div>`;
            teacherForm.innerHTML = formHtml;
        }

        function showView(viewId) { views.forEach(id => document.getElementById(id).classList.add('hidden')); document.getElementById(viewId).classList.remove('hidden'); if (viewId === 'home-screen') { resetAllViews(); } }
        function showLoader(show) { loader.classList.toggle('hidden', !show); }
        function openPasswordModal() { passwordInput.value = ''; passwordError.classList.add('hidden'); passwordModal.classList.remove('hidden'); passwordInput.focus(); }
        function closePasswordModal() { passwordModal.classList.add('hidden'); }
        
        function promptTeacherPassword() {
            const selectedIndex = document.getElementById('teacher-select').value;
            if (selectedIndex === "") { alert('ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุงุณู ุงููุนููุฉ.'); return; }
            currentTeacher = teachersData[selectedIndex];
            document.getElementById('password-modal-title').textContent = `ูููุฉ ูุฑูุฑ ุฃ. ${currentTeacher.name.split(' ')[0]}`;
            openPasswordModal();
        }

        function checkPassword() {
            if (passwordInput.value === currentTeacher.password) {
                closePasswordModal();
                document.getElementById('teacher-view-title').textContent = `ููุญุฉ ุชุญูู: ${currentTeacher.name}`;
                generateTeacherForm();
                showView('teacher-view');
            } else {
                passwordError.classList.remove('hidden');
                passwordInput.value = '';
                passwordInput.focus();
            }
        }
        passwordInput.addEventListener('keyup', e => { if (e.key === 'Enter') { e.preventDefault(); checkPassword(); } });
        
        teacherForm.addEventListener('submit', e => {
            e.preventDefault(); showLoader(true); teacherFeedback.textContent = '';
            const metadata = {
                subject: document.getElementById('subject').value,
                className: document.getElementById('className').value,
                examPassword: document.getElementById('examPassword').value
            };
            const questions = [];
            for (let i = 1; i <= 3; i++) { questions.push({ q: document.getElementById(`q${i}`).value, opt1: document.getElementById(`q${i}_opt1`).value, opt2: document.getElementById(`q${i}_opt2`).value, opt3: document.getElementById(`q${i}_opt3`).value, correct: document.getElementById(`q${i}_correct`).value, score: document.getElementById(`q${i}_score`).value }); }
            
            const url = `${WEB_APP_URL}?action=saveQuestions&sheetId=${currentTeacher.sheetId}&metadata=${encodeURIComponent(JSON.stringify(metadata))}&questions=${encodeURIComponent(JSON.stringify(questions))}`;
            fetch(url).then(res => res.json()).then(result => {
                showLoader(false);
                if (result.status === 'success') {
                    teacherFeedback.textContent = 'ุชู ุญูุธ ุงูุงุฎุชุจุงุฑ ุจูุฌุงุญ!';
                    teacherFeedback.className = 'text-green-600 font-bold';
                    teacherForm.reset();
                } else { throw new Error(result.message || 'ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุนุฑูู ูู ุงูุฎุงุฏู.'); }
            }).catch(error => { showLoader(false); teacherFeedback.textContent = `ูุดู ุงูุญูุธ: ${error.message}`; teacherFeedback.className = 'text-red-600 font-bold'; });
        });

        function findQuiz() {
            const subject = document.getElementById('subject-select').value;
            const className = document.getElementById('class-select').value;
            const password = document.getElementById('exam-password-input').value;
            const errorP = document.getElementById('student-login-error');
            errorP.textContent = '';
            if (!subject || !className || !password) {
                alert('ุงูุฑุฌุงุก ููุก ุฌููุน ุงูุญููู.');
                return;
            }
            showLoader(true);
            const url = `${WEB_APP_URL}?action=findQuiz&subject=${encodeURIComponent(subject)}&className=${encodeURIComponent(className)}&password=${encodeURIComponent(password)}`;
            
            fetch(url).then(res => res.json()).then(result => {
                showLoader(false);
                if (result.status === 'success') {
                    currentSheetId = result.sheetId;
                    document.getElementById('student-view-title').textContent = `ุงุฎุชุจุงุฑ: ${subject} - ${className}`;
                    showView('student-view');
                } else {
                    errorP.textContent = result.message;
                }
            }).catch(error => {
                showLoader(false);
                errorP.textContent = `ุญุฏุซ ุฎุทุฃ: ${error.message}`;
            });
        }

        function startQuiz() {
            const studentName = document.getElementById('student-name').value;
            if (!studentName.trim()) { alert('ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงุณูู.'); return; }
            document.getElementById('student-name-input').classList.add('hidden'); showLoader(true); studentFeedback.textContent = '';
            fetch(`${WEB_APP_URL}?action=getQuestions&sheetId=${currentSheetId}`).then(res => res.json()).then(data => {
                showLoader(false);
                if (data.status === 'success' && data.questions.length > 0) { questionsData = data.questions; displayQuiz(data.questions); } else { throw new Error(data.message || 'ูุง ุชูุฌุฏ ุฃุณุฆูุฉ ูุชุงุญุฉ.'); }
            }).catch(error => { showLoader(false); studentFeedback.textContent = `ูุดู ุชุญููู ุงูุงุฎุชุจุงุฑ: ${error.message}`; studentFeedback.className = 'text-red-600 font-bold'; document.getElementById('student-name-input').classList.remove('hidden'); });
        }
        function displayQuiz(questions) {
            const quizContainer = document.getElementById('quiz-container'); quizContainer.innerHTML = '';
            questions.forEach((q, index) => { const questionDiv = document.createElement('div'); questionDiv.className = 'question-block border-b pb-4'; questionDiv.innerHTML = `<p class="font-semibold text-lg mb-3">${index + 1}. ${q.question}</p><div class="space-y-2"><div><input type="radio" id="q${index}_opt1" name="q${index}" value="1"><label for="q${index}_opt1" class="mr-2">${q.options[0]}</label></div><div><input type="radio" id="q${index}_opt2" name="q${index}" value="2"><label for="q${index}_opt2" class="mr-2">${q.options[1]}</label></div><div><input type="radio" id="q${index}_opt3" name="q${index}" value="3"><label for="q${index}_opt3" class="mr-2">${q.options[2]}</label></div></div>`; quizContainer.appendChild(questionDiv); });
            const submitButton = document.createElement('button'); submitButton.textContent = 'ุฅุฑุณุงู ุงูุฅุฌุงุจุงุช'; submitButton.className = 'bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg mt-4'; submitButton.onclick = submitAnswers; quizContainer.appendChild(submitButton); quizContainer.classList.remove('hidden');
        }
        function submitAnswers() {
            let totalScore = 0, maxScore = 0; const selectedAnswers = [];
            questionsData.forEach((q, index) => { const selectedOption = document.querySelector(`input[name="q${index}"]:checked`); maxScore += parseInt(q.score, 10) || 0; if (selectedOption) { selectedAnswers.push(selectedOption.value); if (selectedOption.value == q.correct) { totalScore += (parseInt(q.score, 10) || 0); } } else { selectedAnswers.push("ูู ุชุชู ุงูุฅุฌุงุจุฉ"); } });
            document.getElementById('quiz-container').classList.add('hidden'); document.getElementById('score-display').textContent = `${totalScore} / ${maxScore}`; document.getElementById('student-result').classList.remove('hidden');
            saveStudentResult(totalScore, selectedAnswers);
        }
        function saveStudentResult(score, answers) {
            const studentName = document.getElementById('student-name').value;
            const url = `${WEB_APP_URL}?action=saveAnswer&sheetId=${currentSheetId}&name=${encodeURIComponent(studentName)}&score=${score}&answers=${encodeURIComponent(JSON.stringify(answers))}`;
            fetch(url).then(res => res.json()).then(data => { if (data.status !== 'success') { console.error('ูุดู ุญูุธ ุงููุชูุฌุฉ:', data.message); } }).catch(error => console.error('ุฎุทุฃ ูู ุงูุดุจูุฉ ุนูุฏ ุญูุธ ุงููุชูุฌุฉ:', error));
        }
        function resetAllViews() {
            document.getElementById('student-name').value = '';
            document.getElementById('student-name-input').classList.remove('hidden');
            document.getElementById('quiz-container').classList.add('hidden');
            document.getElementById('student-result').classList.add('hidden');
            studentFeedback.textContent = '';
            teacherForm.innerHTML = '';
            teacherFeedback.textContent = '';
            questionsData = [];
            currentTeacher = null;
            currentSheetId = '';
        }
    </script>
</body>
</html>
